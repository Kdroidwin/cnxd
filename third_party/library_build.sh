#!/usr/bin/env bash

ABI=$1
ANDROID_SYSTEM_VERSION=$2
BUILD_TYPE=$3

if [ -z "$ANDROID_SDK_ROOT" ]; then
  echo "ERROR: ANDROID_SDK_ROOT isn't set"
  exit 1
fi

ROOT_DIR=$(pwd)
BUILD_DIR=${ROOT_DIR}/build

NDK_VERSION="25.1.8937393"
NDK_DIR="${ANDROID_SDK_ROOT}/ndk/${NDK_VERSION}"
CMAKE_VERSION="3.22.1"
CMAKE_DIR="${ANDROID_SDK_ROOT}/cmake/${CMAKE_VERSION}/bin"
ABI_BUILD_DIR=${ROOT_DIR}/build/${BUILD_TYPE}/${ABI}/
ABI_INSTALL_DIR=${ROOT_DIR}/prebuilt/${BUILD_TYPE}/${ABI}

${CMAKE_DIR}/cmake -B${ABI_BUILD_DIR} \
      -H$(cd $(dirname $0);pwd) \
      -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
      -DANDROID_ABI=${ABI} \
      -DANDROID_PLATFORM=${ANDROID_SYSTEM_VERSION} \
      -DCMAKE_ANDROID_STL_TYPE=c++_static \
      -DCMAKE_TOOLCHAIN_FILE=${NDK_DIR}/build/cmake/android.toolchain.cmake \
      -DANDROID_TOOLCHAIN=clang \
      -DCMAKE_INSTALL_DATAROOTDIR=${ABI_INSTALL_DIR} \
      -DCMAKE_INSTALL_DATADIR=${ABI_INSTALL_DIR} \
      -DCMAKE_INSTALL_PREFIX=${ABI_INSTALL_DIR} \
      -DCMAKE_MAKE_PROGRAM=${CMAKE_DIR}/ninja \
      -GNinja

pushd ${ABI_BUILD_DIR}
  ${CMAKE_DIR}/ninja && ${CMAKE_DIR}/ninja install
popd
